<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† Admin Panel - Turnuva YÃ¶netimi</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="loading">â³ YÃ¼kleniyor...</div>

<div class="container">
    <div class="header">
        <h1>ğŸ† ADMÄ°N PANELÄ°</h1>
        <p>Turnuva YÃ¶netim Sistemi</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" id="tab-puan">ğŸ“Š PUAN DURUMU</button>
        <button class="tab-btn" id="tab-mac">âš½ MAÃ‡ GÄ°RÄ°ÅÄ°</button>
        <button class="tab-btn" id="tab-ayar">âš™ï¸ AYARLAR</button>
    </div>

    <div class="content">
        <div id="content-puan" class="tab-content active">
            <h2>Lider Tablosu</h2>
            <table>
                <thead>
                    <tr>
                        <th>SÄ±ra</th>
                        <th>Oyuncu</th>
                        <th>Oynanan</th>
                        <th>Puan</th>
                        <th>Averaj</th>
                        <th>SÃ¼re (dk)</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr><td colspan="6" style="text-align:center; color:#999;">HenÃ¼z veri yok</td></tr>
                </tbody>
            </table>
        </div>

        <div id="content-mac" class="tab-content">
            <h2>Yeni MaÃ§ Ekle</h2>
            <div class="form-group flex-row">
                <div style="flex:1">
                    <select id="p1Select"><option>Oyuncu 1</option></select>
                </div>
                <div style="flex:1">
                    <input type="number" id="score1" placeholder="Skor" min="0">
                </div>
            </div>
            <div class="form-group flex-row">
                <div style="flex:1">
                    <select id="p2Select"><option>Oyuncu 2</option></select>
                </div>
                <div style="flex:1">
                    <input type="number" id="score2" placeholder="Skor" min="0">
                </div>
            </div>
            <div class="form-group">
                <input type="number" id="matchTime" placeholder="SÃ¼re (Dakika)" min="1">
            </div>
            <button class="action-btn" id="btnSaveMatch">MAÃ‡I KAYDET</button>
            
            <h3 style="margin-top: 30px;">Son MaÃ§lar</h3>
            <ul id="matchHistory"></ul>
        </div>

        <div id="content-ayar" class="tab-content">
            <h2>Oyuncu & Sistem</h2>
            <div class="form-group flex-row">
                <input type="text" id="newPlayerName" placeholder="Oyuncu AdÄ±">
                <button class="action-btn" style="width:auto; background:var(--primary)" id="btnAddPlayer">EKLE</button>
            </div>
            <div style="margin-top:20px;">
                <strong>KayÄ±tlÄ± Oyuncular (<span id="playerCount">0</span>)</strong>
                <ul id="playerList"></ul>
            </div>
            <div style="margin-top:40px; border-top:1px dashed var(--primary); padding-top:20px;">
                <button id="btnReset" style="background:#D32F2F; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; float:right;">âš  TurnuvayÄ± SÄ±fÄ±rla</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBWtAjBA2cBNZdMnR9s88uyV6h61RFMmw0",
    authDomain: "deve-3b098.firebaseapp.com",
    databaseURL: "https://deve-3b098-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "deve-3b098",
    storageBucket: "deve-3b098.firebasestorage.app",
    messagingSenderId: "709312232350",
    appId: "1:709312232350:web:0428b59946fa7ca102348f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let players = [];
let matches = [];
const dbRef = ref(db, 'turnuva');

async function saveToFirebase() {
    try {
        await set(dbRef, { players: players, matches: matches });
    } catch (e) {
        alert("Hata oluÅŸtu: " + e.message);
    }
}

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('content-' + tabId).classList.add('active');
    document.getElementById('tab-' + tabId).classList.add('active');
}

window.deletePlayer = async (id) => {
    if(confirm('Silmek istediÄŸine emin misin?')) {
        players = players.filter(p => p.id !== id);
        await saveToFirebase();
    }
};

window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('loading').style.display = 'block';
    
    onValue(dbRef, (snapshot) => {
        document.getElementById('loading').style.display = 'none';
        if (snapshot.exists()) {
            const data = snapshot.val();
            players = data.players || [];
            matches = data.matches || [];
            renderLeaderboard();
            updateSelects();
            renderPlayerList();
            renderMatchHistory();
        }
    });

    document.getElementById('tab-puan').addEventListener('click', () => switchTab('puan'));
    document.getElementById('tab-mac').addEventListener('click', () => switchTab('mac'));
    document.getElementById('tab-ayar').addEventListener('click', () => switchTab('ayar'));

    document.getElementById('btnAddPlayer').onclick = async () => {
        const nameInput = document.getElementById('newPlayerName');
        const name = nameInput.value.trim();
        if (!name) return alert("Ä°sim giriniz!");
        players.push({ id: Date.now(), name: name, played: 0, wins: 0, points: 0, average: 0, totalTime: 0 });
        nameInput.value = '';
        await saveToFirebase();
    };

    document.getElementById('btnSaveMatch').onclick = async () => {
        const p1Id = parseInt(document.getElementById('p1Select').value);
        const p2Id = parseInt(document.getElementById('p2Select').value);
        const s1 = parseInt(document.getElementById('score1').value);
        const s2 = parseInt(document.getElementById('score2').value);
        const time = parseInt(document.getElementById('matchTime').value);

        if (isNaN(p1Id) || isNaN(p2Id) || p1Id === p2Id) return alert("Oyuncu seÃ§imi hatalÄ±.");
        if (isNaN(s1) || isNaN(s2) || s1 < 0 || s2 < 0) return alert("GeÃ§erli skor giriniz.");
        if (isNaN(time) || time <= 0) return alert("GeÃ§erli sÃ¼re giriniz.");

        let p1 = players.find(p => p.id === p1Id);
        let p2 = players.find(p => p.id === p2Id);

        p1.played++; p2.played++;
        p1.totalTime += time; p2.totalTime += time;
        p1.average += (s1 - s2); p2.average += (s2 - s1);

        if (s1 > s2) { p1.wins++; p1.points += 3; } 
        else if (s2 > s1) { p2.wins++; p2.points += 3; } 
        else { p1.points += 1; p2.points += 1; }

        matches.unshift(`â± ${p1.name} (${s1}) - (${s2}) ${p2.name} | ${time}dk`);
        document.getElementById('score1').value = '';
        document.getElementById('score2').value = '';
        document.getElementById('matchTime').value = '';
        await saveToFirebase();
        alert("MaÃ§ kaydedildi!");
    };

    document.getElementById('btnReset').onclick = async () => {
        if(confirm('DÄ°KKAT! TÃœM VERÄ°TABANI SÄ°LÄ°NECEK!')) {
            players = []; matches = []; await saveToFirebase();
        }
    };
});

function renderLeaderboard() {
    players.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.average !== a.average) return b.average - a.average;
        return a.totalTime - b.totalTime;
    });
    const tbody = document.getElementById('leaderboardBody');
    tbody.innerHTML = '';
    players.forEach((p, index) => {
        let rowClass = index === 0 ? 'rank-1' : '';
        tbody.innerHTML += `<tr class="${rowClass}"><td>${index + 1}</td><td style="font-weight:bold">${p.name}</td><td>${p.played}</td><td>${p.points}</td><td>${p.average > 0 ? '+' + p.average : p.average}</td><td>${p.totalTime}</td></tr>`;
    });
}

function updateSelects() {
    const p1 = document.getElementById('p1Select');
    const p2 = document.getElementById('p2Select');
    p1.innerHTML = '<option>Oyuncu 1</option>';
    p2.innerHTML = '<option>Oyuncu 2</option>';
    players.forEach(p => {
        let opt = `<option value="${p.id}">${p.name}</option>`;
        p1.innerHTML += opt; p2.innerHTML += opt;
    });
    document.getElementById('playerCount').innerText = players.length;
}

function renderPlayerList() {
    const list = document.getElementById('playerList');
    list.innerHTML = '';
    players.forEach(p => {
        list.innerHTML += `<li>${p.name} <button class="delete-btn" onclick="deletePlayer(${p.id})">Sil</button></li>`;
    });
}

function renderMatchHistory() {
    const list = document.getElementById('matchHistory');
    list.innerHTML = '';
    matches.slice(0, 10).forEach(m => { list.innerHTML += `<li>${m}</li>`; });
}
</script>
</body>
</html>
